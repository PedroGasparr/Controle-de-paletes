<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Avan√ßado de Paletes</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        /* Estilos CSS mantidos iguais */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
        }
        .status {
            margin-top: 25px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
        }
        .log {
            margin-top: 25px;
            max-height: 500px;
            overflow-y: auto;
            padding: 15px;
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #34495e;
            line-height: 1.5;
        }
        .last-update {
            font-weight: bold;
            margin-top: 15px;
            color: #2c3e50;
        }
        .next-update {
            font-style: italic;
            color: #7f8c8d;
        }
        .unit-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        .unit-data {
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .unit-data:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .unit-name {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        .data-section {
            margin-bottom: 20px;
        }
        .section-title {
            font-weight: 600;
            color: #3498db;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0 20px;
            font-size: 14px;
        }
        th {
            background-color: #3498db;
            color: white;
            text-align: left;
            padding: 10px;
            font-weight: 600;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #f1f7fd;
        }
        .controls {
            margin: 25px 0;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            min-width: 150px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .error {
            color: #e74c3c;
        }
        .warning {
            color: #f39c12;
        }
        .success {
            color: #27ae60;
        }
        .info {
            color: #3498db;
        }
        .login-form {
            max-width: 450px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .login-form h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
        }
        .login-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        .login-form button {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            font-size: 16px;
        }
        #loginError {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
        }
        .hidden {
            display: none;
        }
        .summary-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .summary-value {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }
        .progress-container {
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #27ae60;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="loginContainer" class="login-form">
        <h2>Controle de Paletes - Login</h2>
        <input type="email" id="email" placeholder="E-mail corporativo">
        <input type="password" id="password" placeholder="Senha">
        <button id="loginBtn">Acessar Sistema</button>
        <p id="loginError"></p>
    </div>

    <div id="appContainer" class="container hidden">
        <h1>Controle Avan√ßado de Paletes por Unidade</h1>
        <p class="info">Sistema de monitoramento completo de paletes, avarias e retrabalhos</p>
        
        <div class="controls">
            <button id="startBtn">‚ñ∂ Iniciar Monitoramento</button>
            <button id="stopBtn" disabled>‚èπ Parar Monitoramento</button>
            <button id="updateNowBtn">üîÑ Atualizar Agora</button>
        </div>
        
        <div class="status">
            <h3>Status do Sistema</h3>
            <p id="serviceStatus">üî¥ Servi√ßo n√£o iniciado</p>
            <p class="last-update">üìÖ √öltima atualiza√ß√£o: <span id="lastUpdate">Nunca</span></p>
            <p class="next-update">‚è± Pr√≥xima atualiza√ß√£o: <span id="nextUpdate">-</span></p>
        </div>
        
        <div id="unitsDataContainer" class="unit-container">
            <!-- Dados das unidades ser√£o inseridos aqui -->
        </div>
        
        <div class="log">
            <h3>üìù Log de Atividades</h3>
            <div id="activityLog"></div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBZE7myNAPADs8yJx8ejr1qnaqV60U-LvU",
            authDomain: "ritmo-44c20.firebaseapp.com",
            databaseURL: "https://ritmo-44c20-default-rtdb.firebaseio.com",
            projectId: "ritmo-44c20",
            storageBucket: "ritmo-44c20.appspot.com",
            messagingSenderId: "784049161032",
            appId: "1:784049161032:web:480bf33cb60e020ca3e97d",
            measurementId: "G-DPYNXD0BNC"
        };

        // Inicializa o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(app);
        const auth = firebase.auth(app);

        // Configura√ß√£o das unidades
        const unitsConfig = {
            "maracanau_ce": "Unidade Maracana√∫",
            "belem_pa": "Unidade Bel√©m",
            "imperatriz_ma": "Unidade Imperatriz",
            "mogi_das_cruzes_sp": "Unidade Mogi das Cruzes",
            "cariacica_es": "Unidade Cariacica",
            "aracruz_es": "Unidade Aracruz",
            "teste_teste": "Unidade Teste"
        };

        // Tipos de paletes
        const palletTypes = ['paleteComum', 'madeirite', 'slipSheet', 'chapatex'];

        // Vari√°veis de controle
        let updateInterval;
        const updateIntervalMinutes = 30;
        let isRunning = false;
        let lastFormattedData = {};

        // Elementos DOM
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const serviceStatus = document.getElementById('serviceStatus');
        const lastUpdate = document.getElementById('lastUpdate');
        const nextUpdate = document.getElementById('nextUpdate');
        const activityLog = document.getElementById('activityLog');
        const unitsDataContainer = document.getElementById('unitsDataContainer');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const updateNowBtn = document.getElementById('updateNowBtn');

        // Fun√ß√£o para adicionar entrada no log
        function addLogEntry(message, type = 'info') {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            let icon = '‚ÑπÔ∏è';
            if (type === 'error') icon = '‚ùå';
            else if (type === 'success') icon = '‚úÖ';
            else if (type === 'warning') icon = '‚ö†Ô∏è';
            
            logEntry.textContent = `${icon} [${timeString}] ${message}`;
            activityLog.appendChild(logEntry);
            activityLog.scrollTop = activityLog.scrollHeight;
        }

        // Fun√ß√£o para formatar data
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                // Se for timestamp em milissegundos
                if (typeof dateString === 'number' || (typeof dateString === 'string' && /^\d+$/.test(dateString))) {
                    return new Date(parseInt(dateString)).toLocaleString('pt-BR');
                }
                // Se j√° for uma string de data
                return new Date(dateString).toLocaleString('pt-BR');
            } catch (e) {
                return dateString;
            }
        }

        // Fun√ß√£o para formatar n√∫meros
        function formatNumber(num) {
            if (num === undefined || num === null || isNaN(num)) return '0';
            return parseInt(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Fun√ß√£o para salvar os dados resumidos no Realtime Database
        async function saveSummaryToDatabase(unitId, summaryData) {
            try {
                // Cria uma estrutura plana com todos os dados diretamente na unidade
                const flatData = {
                    nome: summaryData.nome,
                    ultimaAtualizacao: summaryData.ultimaAtualizacao,
                    atualizadoEm: summaryData.atualizadoEm,
                    totalPaletes: summaryData.totalPaletes,
                    // Custos
                    custo_paleteComum: summaryData.custos.paleteComum || 0,
                    custo_madeirite: summaryData.custos.madeirite || 0,
                    custo_slipSheet: summaryData.custos.slipSheet || 0,
                    custo_chapatex: summaryData.custos.chapatex || 0,
                    // Adicionados
                    adicionados_total: summaryData.adicionados.total,
                    adicionados_paleteComum: summaryData.adicionados.porTipo.paleteComum,
                    adicionados_madeirite: summaryData.adicionados.porTipo.madeirite,
                    adicionados_slipSheet: summaryData.adicionados.porTipo.slipSheet,
                    adicionados_chapatex: summaryData.adicionados.porTipo.chapatex,
                    // Avarias
                    avarias_total: summaryData.avarias.total,
                    avarias_paleteComum: summaryData.avarias.porTipo.paleteComum,
                    avarias_madeirite: summaryData.avarias.porTipo.madeirite,
                    avarias_slipSheet: summaryData.avarias.porTipo.slipSheet,
                    avarias_chapatex: summaryData.avarias.porTipo.chapatex,
                    // Retrabalhos
                    retrabalhos_total: summaryData.retrabalhos.total,
                    retrabalhos_paleteComum: summaryData.retrabalhos.porTipo.paleteComum,
                    retrabalhos_madeirite: summaryData.retrabalhos.porTipo.madeirite,
                    retrabalhos_slipSheet: summaryData.retrabalhos.porTipo.slipSheet,
                    retrabalhos_chapatex: summaryData.retrabalhos.porTipo.chapatex,
                    // Retrabalhos por vez
                    retrabalhos_vez1: summaryData.retrabalhos.porVez.vez_1,
                    retrabalhos_vez2: summaryData.retrabalhos.porVez.vez_2,
                    retrabalhos_vez3: summaryData.retrabalhos.porVez.vez_3,
                    retrabalhos_vez4: summaryData.retrabalhos.porVez.vez_4,
                    retrabalhos_vez5: summaryData.retrabalhos.porVez.vez_5,
                    retrabalhos_vez6: summaryData.retrabalhos.porVez.vez_6,
                    retrabalhos_vez7: summaryData.retrabalhos.porVez.vez_7,
                    retrabalhos_vez8: summaryData.retrabalhos.porVez.vez_8,
                    // Percentual
                    percentualAvaria: summaryData.percentualAvaria
                };

                const summaryRef = database.ref(`control_paletes_kip/${unitId}`);
                await summaryRef.set(flatData);
                addLogEntry(`Dados planos da unidade ${unitsConfig[unitId]} salvos no banco de dados`, 'success');
                return true;
            } catch (error) {
                console.error(`Erro ao salvar dados da unidade ${unitsConfig[unitId]}:`, error);
                addLogEntry(`Erro ao salvar dados da unidade ${unitsConfig[unitId]}: ${error.message}`, 'error');
                return false;
            }
        }

        // Fun√ß√£o para buscar dados de uma unidade - VERS√ÉO CORRIGIDA
        async function fetchUnitData(unitId) {
            try {
                addLogEntry(`Buscando dados para ${unitsConfig[unitId]}...`, 'info');
                
                // Busca os dados em paralelo - caminhos corrigidos
                const [custosSnapshot, lancamentosSnapshot, totalSnapshot] = await Promise.all([
                    database.ref(`custos/${unitId}`).once('value'),
                    database.ref(`lancamentos/${unitId}`).once('value'),
                    database.ref(`totais/${unitId}`).once('value')
                ]);
                
                const custos = custosSnapshot.exists() ? custosSnapshot.val() : {};
                const lancamentos = lancamentosSnapshot.exists() ? lancamentosSnapshot.val() : {};
                const totalPaletes = totalSnapshot.exists() ? totalSnapshot.val() : 0;
                
                // DEBUG: Verificar estrutura dos dados recebidos
                console.log(`Dados recebidos para ${unitId}:`, {
                    custos: custos,
                    lancamentos: lancamentos,
                    totalPaletes: totalPaletes
                });
                
                return {
                    custos: custos,
                    lancamentos: lancamentos,
                    totalPaletes: totalPaletes
                };
                
            } catch (error) {
                console.error(`Erro ao buscar dados para ${unitsConfig[unitId]}:`, error);
                addLogEntry(`Erro ao buscar dados para ${unitsConfig[unitId]}: ${error.message}`, 'error');
                return {
                    custos: {},
                    lancamentos: {},
                    totalPaletes: 0
                };
            }
        }

        // Fun√ß√£o para calcular estat√≠sticas detalhadas - VERS√ÉO CORRIGIDA
        async function calculateUnitStats(unitId) {
            try {
                addLogEntry(`Calculando estat√≠sticas para ${unitsConfig[unitId]}...`, 'info');
                
                const unitData = await fetchUnitData(unitId);
                const hoje = new Date();
                const trintaDiasAtras = new Date();
                trintaDiasAtras.setDate(hoje.getDate() - 30);
                
                // Estruturas para armazenar os dados
                const stats = {
                    adicionados: { total: 0, porTipo: { paleteComum: 0, madeirite: 0, slipSheet: 0, chapatex: 0 } },
                    avarias: { total: 0, porTipo: { paleteComum: 0, madeirite: 0, slipSheet: 0, chapatex: 0 } },
                    retrabalhos: { 
                        total: 0,
                        porVez: { vez_1: 0, vez_2: 0, vez_3: 0, vez_4: 0, vez_5: 0, vez_6: 0, vez_7: 0, vez_8: 0 },
                        porTipo: { paleteComum: 0, madeirite: 0, slipSheet: 0, chapatex: 0 }
                    },
                    ultimaAtualizacao: null
                };
                
                // Processar lan√ßamentos dos √∫ltimos 30 dias
                if (unitData.lancamentos && typeof unitData.lancamentos === 'object') {
                    Object.keys(unitData.lancamentos).forEach(date => {
                        try {
                            const lancDate = new Date(date);
                            if (lancDate >= trintaDiasAtras) {
                                const lancamentos = unitData.lancamentos[date];
                                
                                if (lancamentos && typeof lancamentos === 'object') {
                                    Object.keys(lancamentos).forEach(lancamentoId => {
                                        const lanc = lancamentos[lancamentoId];
                                        
                                        if (lanc && lanc.operacao) {
                                            // Normaliza o tipo
                                            const tipo = lanc.tipo === 'palete' ? 'paleteComum' : 
                                                        (palletTypes.includes(lanc.tipo) ? lanc.tipo : 'paleteComum');
                                            const qtd = parseInt(lanc.quantidade) || 0;
                                            
                                            // Atualiza a √∫ltima atualiza√ß√£o
                                            if (lanc.timestamp && (!stats.ultimaAtualizacao || lanc.timestamp > stats.ultimaAtualizacao)) {
                                                stats.ultimaAtualizacao = lanc.timestamp;
                                            }
                                            
                                            // Processa cada tipo de opera√ß√£o
                                            if (lanc.operacao === 'adicionar') {
                                                stats.adicionados.total += qtd;
                                                stats.adicionados.porTipo[tipo] = (stats.adicionados.porTipo[tipo] || 0) + qtd;
                                            } 
                                            else if (lanc.operacao === 'avaria') {
                                                stats.avarias.total += qtd;
                                                stats.avarias.porTipo[tipo] = (stats.avarias.porTipo[tipo] || 0) + qtd;
                                            } 
                                            else if (lanc.operacao === 'retrabalho') {
                                                stats.retrabalhos.total += qtd;
                                                stats.retrabalhos.porTipo[tipo] = (stats.retrabalhos.porTipo[tipo] || 0) + qtd;
                                                
                                                if (lanc.retrabalhos && typeof lanc.retrabalhos === 'object') {
                                                    for (let i = 1; i <= 8; i++) {
                                                        const vez = `vez_${i}`;
                                                        stats.retrabalhos.porVez[vez] += parseInt(lanc.retrabalhos[vez]) || 0;
                                                    }
                                                }
                                            }
                                        }
                                    });
                                }
                            }
                        } catch (e) {
                            console.error(`Erro ao processar lan√ßamentos em ${date}:`, e);
                            addLogEntry(`Erro ao processar lan√ßamentos em ${date}: ${e.message}`, 'warning');
                        }
                    });
                }
                
                // Calcular percentuais
                const percentualAvaria = stats.adicionados.total > 0 
                    ? (stats.avarias.total / stats.adicionados.total * 100).toFixed(2) 
                    : 0;
                
                // DEBUG: Mostrar estat√≠sticas calculadas
                console.log(`Estat√≠sticas calculadas para ${unitId}:`, {
                    totalPaletes: unitData.totalPaletes,
                    adicionados: stats.adicionados,
                    avarias: stats.avarias,
                    retrabalhos: stats.retrabalhos,
                    percentualAvaria: percentualAvaria
                });
                
                // Retornar os dados formatados
                const result = {
                    nome: unitsConfig[unitId],
                    totalPaletes: unitData.totalPaletes,
                    custos: unitData.custos || {},
                    adicionados: stats.adicionados,
                    avarias: stats.avarias,
                    retrabalhos: stats.retrabalhos,
                    percentualAvaria: percentualAvaria,
                    ultimaAtualizacao: stats.ultimaAtualizacao || null,
                    atualizadoEm: new Date().toISOString()
                };
                
                // Salvar o resumo no banco de dados
                await saveSummaryToDatabase(unitId, result);
                
                addLogEntry(`Estat√≠sticas calculadas para ${unitsConfig[unitId]}`, 'success');
                return result;
                
            } catch (error) {
                console.error(`Erro ao calcular estat√≠sticas para ${unitsConfig[unitId]}:`, error);
                addLogEntry(`Erro ao calcular estat√≠sticas para ${unitsConfig[unitId]}: ${error.message}`, 'error');
                return null;
            }
        }

        // Fun√ß√£o para gerar HTML da tabela de dados
        function generateTableHTML(data, headers, showTotal = true) {
            let html = `<table><tr>`;
            
            // Cabe√ßalho
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += `</tr>`;
            
            // Linhas de dados
            let total = 0;
            palletTypes.forEach(type => {
                const value = data[type] || 0;
                html += `<tr><td>${type.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</td>`;
                html += `<td>${formatNumber(value)}</td></tr>`;
                total += parseInt(value) || 0;
            });
            
            // Total
            if (showTotal) {
                html += `<tr style="font-weight:bold;"><td>Total</td><td>${formatNumber(total)}</td></tr>`;
            }
            
            html += `</table>`;
            return html;
        }

        // Fun√ß√£o para gerar HTML dos retrabalhos por vez
        function generateReworksHTML(reworks) {
            let html = `<table><tr><th>Vez</th><th>Quantidade</th></tr>`;
            
            for (let i = 1; i <= 8; i++) {
                const vez = `vez_${i}`;
                const qtd = reworks[vez] || 0;
                html += `<tr><td>${i}¬™ vez</td><td>${formatNumber(qtd)}</td></tr>`;
            }
            
            html += `<tr style="font-weight:bold;"><td>Total</td><td>${formatNumber(reworks.total)}</td></tr>`;
            html += `</table>`;
            return html;
        }

        // Fun√ß√£o para atualizar a exibi√ß√£o dos dados de uma unidade
        function updateUnitDisplay(unitId, data) {
            let unitElement = document.getElementById(`unit-${unitId}`);
            
            if (!unitElement) {
                unitElement = document.createElement('div');
                unitElement.className = 'unit-data';
                unitElement.id = `unit-${unitId}`;
                unitsDataContainer.appendChild(unitElement);
            }
            
            // Barra de progresso para avarias
            const avariaPercent = parseFloat(data.percentualAvaria) || 0;
            const progressColor = avariaPercent > 5 ? '#e74c3c' : avariaPercent > 2 ? '#f39c12' : '#27ae60';
            
            // HTML da unidade
            unitElement.innerHTML = `
                <div class="unit-name">${data.nome}</div>
                
                <div class="data-section">
                    <div class="section-title">üìä Resumo Geral</div>
                    <div class="summary-card">
                        <div class="data-row">
                            <div class="data-label">Total em Estoque:</div>
                            <div class="summary-value">${formatNumber(data.totalPaletes)}</div>
                        </div>
                        <div class="data-row">
                            <div class="data-label">% de Avarias (30 dias):</div>
                            <div class="summary-value">${data.percentualAvaria}%</div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${Math.min(100, avariaPercent)}%; background-color: ${progressColor}">
                                ${data.percentualAvaria}%
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section">
                    <div class="section-title">üí∞ Custos Unit√°rios (R$)</div>
                    ${generateTableHTML(data.custos, ['Tipo de Palete', 'Custo'], false)}
                </div>
                
                <div class="data-section">
                    <div class="section-title">üì¶ Paletes Adicionados (30 dias)</div>
                    ${generateTableHTML(data.adicionados.porTipo, ['Tipo', 'Quantidade'])}
                </div>
                
                <div class="data-section">
                    <div class="section-title">‚ö†Ô∏è Avarias por Tipo (30 dias)</div>
                    ${generateTableHTML(data.avarias.porTipo, ['Tipo', 'Quantidade'])}
                </div>
                
                <div class="data-section">
                    <div class="section-title">üîÑ Retrabalhos por Tipo (30 dias)</div>
                    ${generateTableHTML(data.retrabalhos.porTipo, ['Tipo', 'Quantidade'])}
                </div>
                
                <div class="data-section">
                    <div class="section-title">üî¢ Retrabalhos por Vez (30 dias)</div>
                    ${generateReworksHTML(data.retrabalhos.porVez)}
                </div>
                
                <div class="data-section">
                    <div class="section-title">‚è± √öltimas Atualiza√ß√µes</div>
                    <div class="data-row">
                        <div class="data-label">√öltimo Registro:</div>
                        <div class="data-value">${formatDate(data.ultimaAtualizacao)}</div>
                    </div>
                    <div class="data-row">
                        <div class="data-label">Dados Atualizados em:</div>
                        <div class="data-value">${formatDate(data.atualizadoEm)}</div>
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o para atualizar todos os dados
        async function updateAllUnitsData() {
            addLogEntry("Iniciando atualiza√ß√£o de dados...", 'info');
            
            try {
                const now = new Date();
                const promises = [];
                
                // Processa cada unidade individualmente
                for (const unitId in unitsConfig) {
                    promises.push(
                        calculateUnitStats(unitId)
                            .then(data => {
                                if (data) {
                                    lastFormattedData[unitId] = data;
                                    updateUnitDisplay(unitId, data);
                                }
                                return data !== null;
                            })
                    );
                }
                
                await Promise.all(promises);
                
                // Atualiza UI
                lastUpdate.textContent = now.toLocaleString('pt-BR');
                const nextUpdateTime = new Date(now.getTime() + updateIntervalMinutes * 60000);
                nextUpdate.textContent = nextUpdateTime.toLocaleTimeString('pt-BR');
                
                addLogEntry("Atualiza√ß√£o conclu√≠da para todas as unidades", 'success');
                return true;
                
            } catch (error) {
                addLogEntry(`Erro durante a atualiza√ß√£o: ${error.message}`, 'error');
                return false;
            }
        }

        // Fun√ß√µes de controle do servi√ßo
        function startService() {
            if (isRunning) return;
            
            isRunning = true;
            serviceStatus.textContent = "üü¢ Servi√ßo em execu√ß√£o";
            serviceStatus.className = "success";
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            updateAllUnitsData();
            updateInterval = setInterval(updateAllUnitsData, updateIntervalMinutes * 60000);
            
            addLogEntry("Servi√ßo de monitoramento iniciado", 'success');
        }

        function stopService() {
            if (!isRunning) return;
            
            isRunning = false;
            clearInterval(updateInterval);
            serviceStatus.textContent = "üî¥ Servi√ßo parado";
            serviceStatus.className = "";
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            addLogEntry("Servi√ßo de monitoramento parado", 'info');
        }

        // Event Listeners
        startBtn.addEventListener('click', startService);
        stopBtn.addEventListener('click', stopService);
        updateNowBtn.addEventListener('click', () => {
            addLogEntry("Atualiza√ß√£o manual solicitada", 'info');
            updateAllUnitsData();
        });

        // Autentica√ß√£o
        loginBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                loginError.textContent = "Por favor, preencha todos os campos";
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    loginError.textContent = '';
                    loginContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    addLogEntry("Autentica√ß√£o bem-sucedida", 'success');
                    serviceStatus.textContent = "üü† Pronto para iniciar";
                })
                .catch((error) => {
                    loginError.textContent = error.message;
                    addLogEntry(`Falha na autentica√ß√£o: ${error.message}`, 'error');
                });
        });

        // Verifica autentica√ß√£o ao carregar
        auth.onAuthStateChanged((user) => {
            if (user) {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                addLogEntry("Sess√£o recuperada. Sistema pronto", 'info');
                serviceStatus.textContent = "üü† Pronto para iniciar";
            }
        });
    </script>
</body>
</html>